# kubectl Debug

The `kubectl debug` allows you to create debug containers and pods for the purpose of problem-solving.
Debug can use https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/ to create a new container in a pod for debugging purposes.

Profiles can be set by using the `--profile` flag. The following profiles are available:

Profile
* legacy:	A set of properties backwards compatibility with 1.22 behavior
* general:	A reasonable set of generic properties for each debugging journey
* baseline:	A set of properties compatible with PodSecurityStandard baseline policy
* restricted:	A set of properties compatible with PodSecurityStandard restricted policy
* netadmin:	A set of properties including Network Administrator privileges
* sysadmin:	A set of properties including System Administrator (root) privileges


```shell
# set up: a container that has a loop that will run for a long time
kubectl create namespace scots-dress
kubectl run kilt -n scots-dress --image nginx --command -- bash -c 'for i in {1..10000}; do echo "Wool stitch counter, $i"; sleep 1; done'

# lets run a special ephemeral container in our kilt pod and atach to it.
kubectl debug kilt -it --image=busybox -n scots-dress --target=kilt -n scots-dress
# view the processes in the pod
ps
exit

# lets see what is happening in the pod
kubectl get pods -n scots-dress
# notice it only seems to have one container 
kubectl describe pods kilt -n scots-dress

# set up:  lets create a pod that will run various commands and sleep for a day
kubectl run sporne --image=nginx -n scots-dress --command -- bash -c 'for i in {1..10000}; do echo "leather stitch counter, $i"; sleep 1; done'
# lets create a copy of the pod and create an ephemeral container and attach to it 
kubectl debug sporne -it --image=ubuntu --share-processes --copy-to=sporne-debug -n scots-dress --container=debug-sporne-container --same-node=false
# lets look at the new pod and container 
kubectl get pods -n scots-dress
kubectl describe pod sporne-debug -n scots-dress

kubectl run bow --image=nginx -n scots-dress --command -- bash -c 'for i in {1..10000}; do echo "silk stitch counter, $i"; sleep 1; done'
# lets create a copy of the pod and delete the original
kubectl debug bow -it --image=ubuntu --share-processes --copy-to=bow-debug -n scots-dress --container=debug-sporne-container --replace=true
# lets look at the new pod and container 
kubectl get pods -n scots-dress
kubectl describe pod bow-debug -n scots-dress

# lets create a new pod that exits immediately
kubectl run sgian-dubh  --image=busybox:1.28 -n scots-dress -- false
kubectl debug sgian-dubh -it --copy-to=sgian-dubh-debug -n scots-dress --container=sgian-dubh -- sh

# start debugging the pod here
kubectl get pods -n scots-dress
kubectl describe pod socks-debug -n scots-dress
# go from one container to another 

# lets create a pod with say a dubug image
kubectl run tamoshanter --image=busybox:1.28 --restart=Never -n scots-dress -- sleep 1d 
# add another container to the pod
kubectl debug tamoshanter --copy-to=tamoshanter-debug --set-image=*=ubuntu -n scots-dress
kubectl get pods -n scots-dress
kubectl describe pod sgian-dubh-debug -n scots-dress

# create a pod on the specific node debugging pod 
# 1: name autogenerated based on node 
# 2: root file system is mounted as /host
# 3: pod is not privialged
kubectl get nodes
kubectl debug node/minikube -it --image=ubuntu -n scots-dress
Kubectl get pods  -n scots-dress
kubectl delete pod ?????? --image=ubuntu -n scots-dress

# If you need a privileged pod, create it manually or use the --profile=sysadmin flag.
kubectl debug node/minikube -it --image=nginx -n scots-dress --profile=sysadmin -- bash
Kubectl get pods  -n scots-dress

kubectl delete namespace scots-dress
```
